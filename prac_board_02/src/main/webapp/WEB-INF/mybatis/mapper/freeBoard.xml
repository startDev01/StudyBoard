<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.study.board.dao.FreeBoardDAO">

	<!-- 게시판 목록 출력 / 공지글 포함 -->
	<select id="getBoardList"
	    resultType="com.study.board.vo.FreeBoardVO"
	    parameterType="com.study.board.vo.PagingVO">
	    SELECT * FROM (
	        SELECT a.*, rownum AS rnum FROM (
	            SELECT
	                b_no, b_title, b_category, b_writer,
	                b_content, b_hit, b_reg_date, b_mod_date,
	                b_del_yn, b_notice_yn, depth,
	                LPAD(' ', depth * 4) || b_title AS display_title
	            FROM free_board
	            WHERE b_del_yn = 'N'
	            START WITH parent_no IS NULL
	            CONNECT BY PRIOR b_no = parent_no
	            ORDER SIBLINGS BY b_no ASC
	        ) a
	    ) b
	    WHERE rnum BETWEEN #{firstRow} and #{lastRow}
	</select>
	
	<!-- 페이징 처리 -->
	<select id="getTotalRowCount" parameterType="com.study.board.vo.PagingVO" resultType="int">
		SELECT count(*)
		FROM free_board
	</select>

	<!-- 특정 게시물 -->
	<select id="getBoard"
		resultType="com.study.board.vo.FreeBoardVO" parameterType="int">
		SELECT b_no
		, b_title, b_category, b_writer
		, b_pass, b_content, b_hit
		,
		to_char(b_reg_date, 'YYYY-MM-DD') AS b_reg_date
		, to_char(b_mod_date,
		'YYYY-MM-DD') AS b_mod_date
		, b_del_yn, b_notice_yn
		FROM free_board
		WHERE b_no=#{bNo}
	</select>

	<!-- 게시물 정보 업데이트 -->
	<update id="updateBoard"
		parameterType="com.study.board.vo.FreeBoardVO">
		UPDATE free_board SET
		b_title=#{bTitle}
		,b_category=#{bCategory}
		,b_content=#{bContent}
		,b_mod_date=sysdate
		WHERE b_no=#{bNo}
	</update>

	<!-- 게시물 삭제 -->
	<delete id="deleteBoard" parameterType="int">
	    DELETE FROM free_board
	    WHERE b_no = #{bNo}
	</delete>

	<!-- 게시물 등록 -->
	<!-- 일반 게시물 등록 / 답글 등록 일때의 경우를 나눠놓음 -->
	<insert id="insertBoard"
		parameterType="com.study.board.vo.FreeBoardVO">

		INSERT INTO free_board (
		b_no, b_title, b_category,
		b_writer, b_pass, b_content, b_hit,
		b_reg_date, b_mod_date, b_del_yn,
		b_notice_yn
		) VALUES (
		seq_free_board.nextval, #{bTitle,
		jdbcType=VARCHAR},
		#{bCategory, jdbcType=VARCHAR},
		#{bWriter,
		jdbcType=VARCHAR}, #{bPass, jdbcType=VARCHAR},
		#{bContent,
		jdbcType=VARCHAR}, 0, SYSDATE, null, 'N',
		#{bNoticeYn, jdbcType=CHAR}
		)
	</insert>

	<!-- 답변글 생성 -->
	<insert id="insertReplyBoard"
		parameterType="com.study.board.vo.FreeBoardVO">

		INSERT INTO free_board (
		b_no, b_title, b_category,
		b_writer, b_pass, b_content, b_hit,
		b_reg_date, b_mod_date, b_del_yn,
		b_notice_yn, parent_no, depth
		) VALUES (
		seq_free_board.nextval,
		#{bTitle, jdbcType=VARCHAR},
		#{bCategory, jdbcType=VARCHAR},
		#{bWriter,
		jdbcType=VARCHAR}, #{bPass, jdbcType=VARCHAR},
		#{bContent,
		jdbcType=VARCHAR}, 0, SYSDATE, null, 'N',
		#{bNoticeYn, jdbcType=CHAR},
		#{parentNo, jdbcType=INTEGER},
		(SELECT NVL(MAX(depth), 0) + 1 FROM
		free_board WHERE parent_no = #{parentNo})
		)
	</insert>

	<!-- 최대 depth 조회 -->
	<select id="getMaxDepth" resultType="int">
		SELECT COALESCE(MAX(depth),
		0) FROM free_board
	</select>

	<!-- 조회수 -->
	<update id="updateViewCnt"
		parameterType="com.study.board.vo.FreeBoardVO">
		UPDATE free_board
		SET b_hit = b_hit + 1
		where b_no =
		#{bNo}
	</update>

</mapper>